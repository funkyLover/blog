---
layout: post
title: "2019-06-02"
date: 2019-06-02
tags: [小程序]
comments: true
share: true
---

> [2019-06-07]使用`body-parser`处理过后的请求不能直接通过`http-proxy-middleware`来转发 <br>
> [2019-06-02]微信小程序部分安卓机器, 使用手写输入法会因为草稿状态导致不能触发input事件 <br>

##### [2019-06-07]koa使用`body-parser`处理过后的请求不能直接通过`http-proxy-middleware`来转发

相关参考issue

- https://github.com/nodejitsu/node-http-proxy/issues/1279
- https://github.com/chimurai/http-proxy-middleware/issues/299
- https://github.com/nodejitsu/node-http-proxy/blob/master/examples/middleware/bodyDecoder-middleware.js

```js
const proxyMiddleware = async (ctx, next) => {
  const host = getProxyHost(ctx);
  const proxy = httpProxy({
    target: host,
    logLevel: 'debug',
    onProxyReq: (proxyReq, req, res) => {
      // @TODO: 知道如何解决了，但还没搞请求bodyparser对请求动了什么手脚导致代理失败
      req.body = ctx.request.body;
      if (!req.body || !Object.keys(req.body).length) {
        return;
      }

      var contentType = proxyReq.getHeader('Content-Type');
      var bodyData;

      if (contentType === 'application/json') {
        bodyData = JSON.stringify(req.body);
      }

      if (contentType === 'application/x-www-form-urlencoded') {
        bodyData = queryString.stringify(req.body);
      }

      if (bodyData) {
        proxyReq.setHeader('Content-Length', Buffer.byteLength(bodyData));
        proxyReq.write(bodyData);
      }
    }
  });

  await koaConnect(proxy)(ctx, next);
};
```

##### [2019-06-02]微信小程序部分安卓机器, 使用手写输入法会因为草稿状态导致不能触发input事件

如图所示

![输入法](/images/2019-06/input.png "菜单 -> 调试 -> 安装调试附加器")

草稿状态即用户输入之后还要再点一下选哪个字或点确认才算输入完成

有时候用户发现出来的第一个字就是他们想要输入的, 他们可能就不会去再去点击确认

但是微信小程序的input组件在部分安卓机器下, 只有点击选取某个字或确认才会触发`bindinput`事件

如果使用的`bindinput`来获取用户输入要注意在页面上提示用户

> 针对这种情况, 还没试过使用`form#bindsubmit`事件能不能获取到用户输入
